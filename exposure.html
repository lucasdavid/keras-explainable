<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8">
    <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <title>Exposing Intermediate Signals</title>
    

    <link rel="stylesheet" href="_static/css/redactor.css" type="text/css" />
    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <link rel="stylesheet" href="_static/css/redactor.css" type="text/css" />
    
    <link rel="stylesheet" href="_static/jupyter-sphinx.css" type="text/css" />
    
    <link rel="stylesheet" href="_static/thebelab.css" type="text/css" />
    
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    
    
    <link rel="index" title="Index" href="genindex.html"/>
    <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Keras Explainable" href="index.html"/>
    <link rel="next" title="AI Explaining Methods" href="methods/index.html"/>
    <link rel="prev" title="Explaining Model’s Predictions" href="explaining.html"/> 
</head>

<body role="document">
     

    
<a href="#" id="js-navigation-toggle" class="navigation-toggle">
    <i class="mdi mdi-menu"></i><i class="mdi mdi-close"></i>
</a>

<section class="site-sidebar">

<nav>


    <a href="index.html" class="branding-link">
    
        keras-explainable
    
    
    
        
        
            <span class="branding-link__version">
                0.0.2
            </span>
        
    
    </a>

    
<section role="search">
    <form action="search.html" method="get" class="site-searchform">
        <input type="text" name="q" placeholder="Search docs" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
</section>



    <section class="site-nav">
    
    
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="explaining.html">Explaining</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Exposure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-exposition-examples">Simple Exposition Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exposing-nested-models">Exposing Nested Models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="methods/index.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="wsol.html">WSSL &amp; WSSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributions &amp; Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">Module Reference</a></li>
</ul>

    
    </section>

</nav>

</section>

    <main class="site-main" role="main">
        











<nav class="site-breadcrumbs">
    <ul>
    
        <li>
            <a href="index.html">Docs</a> /
        </li>
        
        <li class="site-breadcrumbs__leaf">Exposing Intermediate Signals</li>
    
    </ul>
</nav>
        <section class="site-content">
            <div class="container">
                
  <section id="exposing-intermediate-signals">
<h1>Exposing Intermediate Signals<a class="headerlink" href="#exposing-intermediate-signals" title="Permalink to this heading">¶</a></h1>
<p>This page details the exposure procedure, necessary for most AI explaining
methods, and which can be easened with the help of the
<a class="reference internal" href="api/keras_explainable.html#keras_explainable.inspection.expose" title="keras_explainable.inspection.expose"><code class="xref py py-func docutils literal notranslate"><span class="pre">expose()</span></code></a> function.</p>
<section id="simple-exposition-examples">
<h2>Simple Exposition Examples<a class="headerlink" href="#simple-exposition-examples" title="Permalink to this heading">¶</a></h2>
<p>Many explaining techniques require us to expose the intermediate tensors
so their respective signals can be used, or so the gradient of the output
can be computed with respect to their signals.
For example, Grad-CAM computes the gradient of an output unit with respect
to the activation signal advent from the last positional layer in the model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
  <span class="n">logits</span><span class="p">,</span> <span class="n">activations</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">batch_jacobian</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">activations</span><span class="p">)</span>
</pre></div>
</div>
<p>Which evidently means the <code class="docutils literal notranslate"><span class="pre">activations</span></code> signal, a tensor of
shape <code class="docutils literal notranslate"><span class="pre">(batch,</span> <span class="pre">height,</span> <span class="pre">width,</span> <span class="pre">...,</span> <span class="pre">kernels)</span></code> must be available at runtime.
For that to happen, we must redefine the model, setting its outputs
to contain the <code class="xref py py-class docutils literal notranslate"><span class="pre">KerasTensor</span></code>’s objects that reference both
<code class="docutils literal notranslate"><span class="pre">logits</span></code> and <code class="docutils literal notranslate"><span class="pre">activations</span></code> tensors:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.applications</span> <span class="kn">import</span> <span class="n">ResNet50V2</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">GlobalAveragePooling2D</span>

<span class="kn">import</span> <span class="nn">keras_explainable</span> <span class="k">as</span> <span class="nn">ke</span>

<span class="n">rn50</span> <span class="o">=</span> <span class="n">ResNet50V2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">classifier_activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># activations_tensor = rn50.get_layer(&quot;avg_pool&quot;).input  # or...</span>
<span class="n">activations_tensor</span> <span class="o">=</span> <span class="n">rn50</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;post_relu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">rn50</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="p">[</span><span class="n">rn50</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">activations_tensor</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  input: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  outputs:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>model
  input: KerasTensor(type_spec=TensorSpec(shape=(None, 224, 224, 3), dtype=tf.float32, name=&#39;input_1&#39;), name=&#39;input_1&#39;, description=&quot;created by layer &#39;input_1&#39;&quot;)
  outputs:
    KerasTensor(type_spec=TensorSpec(shape=(None, 1000), dtype=tf.float32, name=None), name=&#39;predictions/BiasAdd:0&#39;, description=&quot;created by layer &#39;predictions&#39;&quot;)
    KerasTensor(type_spec=TensorSpec(shape=(None, 7, 7, 2048), dtype=tf.float32, name=None), name=&#39;post_relu/Relu:0&#39;, description=&quot;created by layer &#39;post_relu&#39;&quot;)
</pre></div>
</div>
</div>
</div>
<p>Which can be simplified with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">rn50</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="api/keras_explainable.html#keras_explainable.inspection.expose" title="keras_explainable.inspection.expose"><code class="xref py py-func docutils literal notranslate"><span class="pre">expose()</span></code></a> function inspects the model,
seeking for the <em>logits</em> layer (the last containing a kernel property) and the
<em>global pooling</em> layer, an instance of a <code class="xref py py-class docutils literal notranslate"><span class="pre">GlobalPooling</span></code> or
<code class="xref py py-class docutils literal notranslate"><span class="pre">Flatten</span></code> layer classes. The output of the former and the input of the
latter are collected and a new model is defined.</p>
<p>You can also manually indicate the name of the argument and output layers.
All options bellow are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">rn50</span><span class="p">,</span> <span class="s2">&quot;post_relu&quot;</span><span class="p">,</span> <span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
  <span class="n">rn50</span><span class="p">,</span>
  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;post_relu&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;output&quot;</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;predictions&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
  <span class="n">rn50</span><span class="p">,</span>
  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;post_relu&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;predictions&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
  <span class="n">rn50</span><span class="p">,</span>
  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;avg_pool&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;input&quot;</span><span class="p">},</span>
  <span class="s2">&quot;predictions&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Grad-CAM (or Grad-CAM++) can be called immediately after that:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

<span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scores:</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cams:</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>scores:(4, 1) in [-0.1541651487350464, -0.0010260604321956635]
cams:(4, 224, 224, 1) in [0.0, 0.9939659237861633]
</pre></div>
</div>
</div>
</div>
</section>
<section id="exposing-nested-models">
<h2>Exposing Nested Models<a class="headerlink" href="#exposing-nested-models" title="Permalink to this heading">¶</a></h2>
<p>Unfortunately, some model’s topologies can make exposition a little tricky.
An example of this is when nesting multiple models, producing more than one
<code class="docutils literal notranslate"><span class="pre">Input</span></code> object and multiple conceptual graphs at once.
Then, if one naively collects <code class="docutils literal notranslate"><span class="pre">KerasTensor</span></code>’s from the model, disconnected
nodes may be retrieved, resulting in the exception <code class="docutils literal notranslate"><span class="pre">ValueError:</span> <span class="pre">Graph</span> <span class="pre">disconnected</span></code>
being raised:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rn50</span> <span class="o">=</span> <span class="n">ResNet50V2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">Input</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_images&quot;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rn50</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;avg_pool&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;logits&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

<span class="n">rn50_clf</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;resnet50v2_clf&quot;</span><span class="p">)</span>
<span class="n">rn50_clf</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">logits</span> <span class="o">=</span> <span class="n">rn50_clf</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;logits&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
<span class="n">activations</span> <span class="o">=</span> <span class="n">rn50_clf</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;resnet50v2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">rn50_clf</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="p">[</span><span class="n">logits</span><span class="p">,</span> <span class="n">activations</span><span class="p">])</span>
<span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scores:</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cams:</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>Model: &quot;resnet50v2_clf&quot;
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>_________________________________________________________________
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> Layer (type)                Output Shape              Param #   
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>=================================================================
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> input_images (InputLayer)   [(None, 224, 224, 3)]     0         
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> resnet50v2 (Functional)     (None, None, None, 2048)  23564800  
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> avg_pool (GlobalAveragePool  (None, 2048)             0         
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> ing2D)                                                          
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> logits (Dense)              (None, 10)                20490     
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> predictions (Activation)    (None, 10)                0         
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>=================================================================
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>Total params: 23,585,290
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>Trainable params: 23,539,850
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>Non-trainable params: 45,440
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>_________________________________________________________________
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span> <span class="mi">15</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">rn50_clf</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;logits&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">activations</span> <span class="o">=</span> <span class="n">rn50_clf</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;resnet50v2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
<span class="ne">---&gt; </span><span class="mi">15</span> <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">rn50_clf</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="p">[</span><span class="n">logits</span><span class="p">,</span> <span class="n">activations</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
<span class="nn">     18 print(f&quot;scores:{scores.shape}</span> in <span class="ni">[{scores.min()}, {scores.max</span><span class="nt">()}]&quot;)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/tensorflow/python/trackable/base.py:205,</span> in <span class="ni">no_automatic_dependency_tracking.&lt;locals&gt;._method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">205</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras/engine/functional.py:165,</span> in <span class="ni">Functional.__init__</span><span class="nt">(self, inputs, outputs, name, trainable, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span>     <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">157</span>         <span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span>             <span class="n">functional_utils</span><span class="o">.</span><span class="n">is_input_keras_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nn">    159             for t</span> in <span class="ni">tf.nest.flatten</span><span class="nt">(inputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">160</span>         <span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span>     <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">162</span>         <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">functional_utils</span><span class="o">.</span><span class="n">clone_graph_nodes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">163</span>             <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span>         <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">165</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_graph_network</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/tensorflow/python/trackable/base.py:205,</span> in <span class="ni">no_automatic_dependency_tracking.&lt;locals&gt;._method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">205</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras/engine/functional.py:264,</span> in <span class="ni">Functional._init_graph_network</span><span class="nt">(self, inputs, outputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_input_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">node_index</span><span class="p">,</span> <span class="n">tensor_index</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span> <span class="c1"># Keep track of the network&#39;s nodes and layers.</span>
<span class="ne">--&gt; </span><span class="mi">264</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">nodes_by_depth</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_map_graph_network</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_nodes</span> <span class="o">=</span> <span class="n">nodes</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_by_depth</span> <span class="o">=</span> <span class="n">nodes_by_depth</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras/engine/functional.py:1128,</span> in <span class="ni">_map_graph_network</span><span class="nt">(inputs, outputs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1126</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">keras_inputs</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1127</span>     <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">computable_tensors</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1128</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1129</span>             <span class="sa">f</span><span class="s2">&quot;Graph disconnected: cannot obtain value for &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1130</span>             <span class="sa">f</span><span class="s1">&#39;tensor </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> at layer &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;. &#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">1131</span>             <span class="s2">&quot;The following previous layers were accessed &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1132</span>             <span class="sa">f</span><span class="s2">&quot;without issue: </span><span class="si">{</span><span class="n">layers_with_complete_input</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1133</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1134</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1135</span>     <span class="n">computable_tensors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="ne">ValueError</span>: Graph disconnected: cannot obtain value for tensor KerasTensor(type_spec=TensorSpec(shape=(None, None, None, 3), dtype=tf.float32, name=&#39;input_2&#39;), name=&#39;input_2&#39;, description=&quot;created by layer &#39;input_2&#39;&quot;) at layer &quot;conv1_pad&quot;. The following previous layers were accessed without issue: []
</pre></div>
</div>
</div>
</div>
<p>The operations in <code class="docutils literal notranslate"><span class="pre">rn50</span></code> appear in two conceptual graphs. The first, defined
when <code class="docutils literal notranslate"><span class="pre">ResNet50V2(...)</span></code> was invoked, contains all operations associated with the layers
in the ResNet50 architecture. The second one, on the other hand, is defined when
invoking <code class="xref py py-meth docutils literal notranslate"><span class="pre">Layer.__call__()</span></code> of each layer (<code class="docutils literal notranslate"><span class="pre">rn50</span></code>, <code class="docutils literal notranslate"><span class="pre">GAP</span></code>, <code class="docutils literal notranslate"><span class="pre">Dense</span></code> and
<code class="docutils literal notranslate"><span class="pre">Activation</span></code>).</p>
<p>When calling <code class="docutils literal notranslate"><span class="pre">rn50_clf.get_layer(&quot;resnet50v2&quot;).output</span></code> (which is equivalent
to <code class="docutils literal notranslate"><span class="pre">rn50_clf.get_layer(&quot;resnet50v2&quot;).get_output_at(0)</span></code>), the <code class="xref py py-class docutils literal notranslate"><span class="pre">Node</span></code>
from the first graph is retrieved.
This <code class="docutils literal notranslate"><span class="pre">Node</span></code> is not associated with <code class="docutils literal notranslate"><span class="pre">rn50_clf.input</span></code> or <code class="docutils literal notranslate"><span class="pre">logits</span></code>, and thus
the error is raised.</p>
<p>There are multiple ways to correctly access the Node from the second graph. One of them
is to retrieve the input from the <code class="docutils literal notranslate"><span class="pre">GAP</span></code> layer, as it only appeared in one graph:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
  <span class="n">rn50_clf</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;avg_pool&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;input&quot;</span><span class="p">},</span> <span class="s2">&quot;predictions&quot;</span>
<span class="p">)</span>
<span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scores:</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cams:</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>scores:(4, 1) in [0.09053877741098404, 0.11063539236783981]
cams:(4, 224, 224, 1) in [0.0, 0.994608461856842]
</pre></div>
</div>
</div>
</div>
<div class="jupyter_cell docutils container">
<div class="cell_output docutils container">
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The alternatives <code class="docutils literal notranslate"><span class="pre">ke.inspection.expose(rn50_clf,</span> <span class="pre">&quot;resnet50v2&quot;,</span> <span class="pre">&quot;predictions&quot;)</span></code>
and <code class="docutils literal notranslate"><span class="pre">ke.inspection.expose(rn50_clf)</span></code> would work as well.
In the former, the <strong>last</strong> output node is retrieved.
In the latter, the <strong>last</strong> input node (there’s only one) associated
with the <code class="docutils literal notranslate"><span class="pre">GAP</span></code> layer is retrieved.</p>
</div>
<section id="access-nested-layer-signals">
<h3>Access Nested Layer Signals<a class="headerlink" href="#access-nested-layer-signals" title="Permalink to this heading">¶</a></h3>
<p>Another problem occurs when the global pooling layer is not part of layers set
of the out-most model. While you can still collect its output using a name
composition, we get a <code class="docutils literal notranslate"><span class="pre">ValueError:</span> <span class="pre">Graph</span> <span class="pre">disconnected</span></code>.</p>
<p>This problem occurs because Keras does not create <code class="docutils literal notranslate"><span class="pre">Nodes</span></code> for inner layers in a nested
model, when that model is reused. Instead, the model is treated as a single operation
in the conceptual graph, with a single new <code class="docutils literal notranslate"><span class="pre">Node</span></code> being created to represent it.
Calling <a class="reference internal" href="api/keras_explainable.html#keras_explainable.inspection.expose" title="keras_explainable.inspection.expose"><code class="xref py py-func docutils literal notranslate"><span class="pre">keras_explainable.inspection.expose()</span></code></a> over the model will expand the
parameter <code class="docutils literal notranslate"><span class="pre">arguments</span></code> into <code class="docutils literal notranslate"><span class="pre">{&quot;name&quot;:</span> <span class="pre">(&quot;ResNet50V2&quot;,</span> <span class="pre">&quot;avg_pool&quot;),</span> <span class="pre">&quot;link&quot;:</span> <span class="pre">&quot;input&quot;,</span> <span class="pre">&quot;node&quot;:</span> <span class="pre">&quot;last&quot;}</span></code>,
but because no new nodes were created for the <code class="docutils literal notranslate"><span class="pre">GAP</span></code> layer, the <code class="xref py py-class docutils literal notranslate"><span class="pre">KerasTensor</span></code>
associated with the first conceptual graph is retrieved, and the error ensues.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rn50</span> <span class="o">=</span> <span class="n">ResNet50V2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pooling</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">)</span>
<span class="n">rn50_clf</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
  <span class="n">Input</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_images&quot;</span><span class="p">),</span>
  <span class="n">rn50</span><span class="p">,</span>
  <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;logits&quot;</span><span class="p">),</span>
  <span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">rn50_clf</span><span class="p">)</span>
<span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scores:</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cams:</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cams</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">9</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">rn50</span> <span class="o">=</span> <span class="n">ResNet50V2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pooling</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">rn50_clf</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>   <span class="n">Input</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_images&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>   <span class="n">rn50</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>   <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;logits&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>   <span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">rn50_clf</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
<span class="nn">     12 print(f&quot;scores:{scores.shape}</span> in <span class="ni">[{scores.min()}, {scores.max</span><span class="nt">()}]&quot;)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras_explainable/inspection.py:263,</span> in <span class="ni">expose</span><span class="nt">(model, arguments, outputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">tolist</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span> <span class="n">tensors</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">+</span> <span class="n">arguments</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">263</span> <span class="k">return</span> <span class="n">Model</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>     <span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="n">outputs</span><span class="o">=</span><span class="n">tensors</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/tensorflow/python/trackable/base.py:205,</span> in <span class="ni">no_automatic_dependency_tracking.&lt;locals&gt;._method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">205</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras/engine/functional.py:165,</span> in <span class="ni">Functional.__init__</span><span class="nt">(self, inputs, outputs, name, trainable, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span>     <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">157</span>         <span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span>             <span class="n">functional_utils</span><span class="o">.</span><span class="n">is_input_keras_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nn">    159             for t</span> in <span class="ni">tf.nest.flatten</span><span class="nt">(inputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">160</span>         <span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span>     <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">162</span>         <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">functional_utils</span><span class="o">.</span><span class="n">clone_graph_nodes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">163</span>             <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span>         <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">165</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_graph_network</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/tensorflow/python/trackable/base.py:205,</span> in <span class="ni">no_automatic_dependency_tracking.&lt;locals&gt;._method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">205</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras/engine/functional.py:264,</span> in <span class="ni">Functional._init_graph_network</span><span class="nt">(self, inputs, outputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_input_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">node_index</span><span class="p">,</span> <span class="n">tensor_index</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span> <span class="c1"># Keep track of the network&#39;s nodes and layers.</span>
<span class="ne">--&gt; </span><span class="mi">264</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">nodes_by_depth</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_map_graph_network</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_nodes</span> <span class="o">=</span> <span class="n">nodes</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_by_depth</span> <span class="o">=</span> <span class="n">nodes_by_depth</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.8/x64/lib/python3.10/site-packages/keras/engine/functional.py:1128,</span> in <span class="ni">_map_graph_network</span><span class="nt">(inputs, outputs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1126</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">keras_inputs</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1127</span>     <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">computable_tensors</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1128</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1129</span>             <span class="sa">f</span><span class="s2">&quot;Graph disconnected: cannot obtain value for &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1130</span>             <span class="sa">f</span><span class="s1">&#39;tensor </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> at layer &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;. &#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">1131</span>             <span class="s2">&quot;The following previous layers were accessed &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1132</span>             <span class="sa">f</span><span class="s2">&quot;without issue: </span><span class="si">{</span><span class="n">layers_with_complete_input</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1133</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1134</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1135</span>     <span class="n">computable_tensors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="ne">ValueError</span>: Graph disconnected: cannot obtain value for tensor KerasTensor(type_spec=TensorSpec(shape=(None, None, None, 3), dtype=tf.float32, name=&#39;input_3&#39;), name=&#39;input_3&#39;, description=&quot;created by layer &#39;input_3&#39;&quot;) at layer &quot;conv1_pad&quot;. The following previous layers were accessed without issue: []
</pre></div>
</div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since TensorFlow 2, nodes are no longer being stacked in <code class="docutils literal notranslate"><span class="pre">_inbound_nodes</span></code>
for layers in nested models, which obstructs the access to intermediate
signals contained in a nested model, and makes the remaining of this
document obsolete.
To avoid this problem, it is recommended to “flat out” the model before
explaining it, or avoiding nesting models altogether.</p>
<p>For more information, see the GitHub issue
<a class="reference external" href="https://github.com/keras-team/keras/issues/16123">#16123</a>.</p>
</div>
<p>If you are using TensorFlow &lt; 2.0, nodes are created for each operation
in the inner model, and you may collect their internal signal by simply:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">inspection</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">rn50_clf</span><span class="p">)</span>
<span class="c1"># ... or: ke.inspection.expose(rn50_clf, (&quot;resnet50v2&quot;, &quot;post_relu&quot;))</span>
<span class="c1"># ... or: ke.inspection.expose(</span>
<span class="c1">#  rn50_clf, {&quot;name&quot;: (&quot;resnet50v2&quot;, &quot;avg_pool&quot;), &quot;link&quot;: &quot;input&quot;}</span>
<span class="c1"># )</span>

<span class="n">scores</span><span class="p">,</span> <span class="n">cams</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">gradcam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above works because <a class="reference internal" href="api/keras_explainable.html#keras_explainable.inspection.expose" title="keras_explainable.inspection.expose"><code class="xref py py-func docutils literal notranslate"><span class="pre">expose()</span></code></a>
will recursively seek for a <code class="docutils literal notranslate"><span class="pre">GAP</span></code> layer within the nested models.</p>
</div>
</section>
</section>
</section>


            </div>

        </section>

        
            <nav class="site-bottom-navigation" role="navigation">
            
                <a href="methods/index.html" class="btn btn--primary btn--next right"
                    title="AI Explaining Methods" accesskey="n">
                    Next
                </a>
            
            
                <a href="explaining.html" class="btn btn--primary btn--prev"
                    title="Explaining Model’s Predictions" accesskey="p">
                    Previous
                </a>
            
            </nav>
        

        
            <div class="source-link">
            
                
                    <a href="_sources/exposure.rst.txt" rel="nofollow">
                        <i class="mdi mdi-code-tags"></i>
                        View page source
                    </a>
                
            
            </div>
        



    </main>

    <footer class="site-footer">
<div class="container">

    <div role="contentinfo">
        <p>
                &copy; Copyright 2022, Lucas David.
        </p>
    </div> 

</div>
</footer>

    

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'',
            VERSION:'0.0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="_static/thebelab-helper.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script type="text/javascript" src="_static/js/theme-min.js"></script> 
</body>
</html>